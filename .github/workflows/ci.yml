name: Backend CI

on:
    push:
        branches: [main]
        paths:
            - "Proj 2/Howl2Go_backend/**"
            - ".github/workflows/**"
    pull_request:
        paths:
            - "Proj 2/Howl2Go_backend/**"
            - ".github/workflows/**"

concurrency:
    group: backend-ci-${{ github.ref }}-${{ github.event.pull_request.number || github.run_id }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js 18
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: npm
                  cache-dependency-path: |
                      Proj 2/Howl2Go_backend/package-lock.json

            - name: Install backend dependencies
              run: npm ci
              working-directory: "Proj 2/Howl2Go_backend"

            # Create .env for tests: combine defaults + secrets
            - name: Create .env from example + GitHub Secrets
              run: |
                  # Start from .env.example (safe defaults)
                  if [ -f .env.example ]; then cp .env.example .env; else :; fi

                  # Overwrite with sensitive/test credentials from GitHub Secrets
                  {
                    echo "PORT=4000"
                    echo "NODE_ENV=development"

                    echo "MONGODB_URI=${{ secrets.MONGODB_URI }}"

                    echo "JWT_SECRET=${{ secrets.JWT_SECRET }}"
                    echo "JWT_EXPIRES_IN=7d"
                    echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}"
                    echo "JWT_REFRESH_EXPIRES_IN=30d"

                    echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}"
                    echo "SESSION_NAME=howl2go.sid"
                    echo "SESSION_MAX_AGE=86400000"

                    echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}"

                    # Optional: DoorDash API keys (only if used in tests)
                    # echo "DOORDASH_DEVELOPER_ID=${{ secrets.DOORDASH_DEVELOPER_ID }}"
                    # echo "DOORDASH_KEY_ID=${{ secrets.DOORDASH_KEY_ID }}"
                    # echo "DOORDASH_SIGNING_SECRET=${{ secrets.DOORDASH_SIGNING_SECRET }}"
                  } > .env

                  echo ".env created with $(grep -c '=' .env) entries"
              working-directory: "Proj 2/Howl2Go_backend"

            # Run backend tests (they will connect to Atlas)
            - name: Run backend tests (with coverage)
              env:
                  CI: "true"
              run: npm test -- --coverage
              working-directory: "Proj 2/Howl2Go_backend"

            - name: Upload coverage artifact
              uses: actions/upload-artifact@v4
              with:
                  name: backend-coverage
                  path: Proj 2/Howl2Go_backend/coverage/**
                  if-no-files-found: warn

            - name: Send coverage to Coveralls
              run: npm run coverage

            # === Optional: Codecov integration (for coverage badges) ===
            # - name: Upload coverage to Codecov
            #   uses: codecov/codecov-action@v4
            #   with:
            #     files: Proj 2/Howl2Go_backend/coverage/lcov.info
            #     flags: backend
            #     fail_ci_if_error: true
            #   env:
            #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
